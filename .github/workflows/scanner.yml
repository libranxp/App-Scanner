name: Run Scanner

on:
  schedule:
    - cron: '*/10 * * * *'   # every 10 minutes
  workflow_dispatch:          # manual trigger

jobs:
  run-scanner:
    runs-on: ubuntu-latest

    env:
      # API KEYS (from your secrets)
      FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
      FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
      ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
      POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      NEWSAPI_API_KEY: ${{ secrets.NEWSAPI_API_KEY }}
      COINMARKETCAL_API_KEY: ${{ secrets.COINMARKETCAL_API_KEY }}
      LUNARCRUSH_API_KEY: ${{ secrets.LUNARCRUSH_API_KEY }}
      MESSARI_API_KEY: ${{ secrets.MESSARI_API_KEY }}
      SANTIMENT_API_KEY: ${{ secrets.SANTIMENT_API_KEY }}
      COINGLASS_API_KEY: ${{ secrets.COINGLASS_API_KEY }}
      REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
      REDDIT_SECRET: ${{ secrets.REDDIT_SECRET }}
      TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}

      # TELEGRAM
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_STOCKS_CHANNEL_ID: ${{ secrets.TELEGRAM_STOCKS_CHANNEL_ID }}
      TELEGRAM_CRYPTO_CHANNEL_ID: ${{ secrets.TELEGRAM_CRYPTO_CHANNEL_ID }}

      # GITHUB AUTH
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Scanner
        run: python scanner.py

      - name: Commit & Push dashboard.json
        if: success() && env.PAT_TOKEN != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f dashboard.json
          git commit -m "Update dashboard data [skip ci]" || echo "No changes"
          git push https://x-access-token:${PAT_TOKEN}@github.com/${{ github.repository }} HEAD:main
